from azure.iot.device import IoTHubModuleClient, Message
from azure.iot.device.iothub.aio import IoTHubModuleClient

import asyncio
import mainenc

async def on_twin_desired_properties_update(patch):
    print("Getting twin:")
    print(patch)
    if patch:
        devices = patch
        module_client = IoTHubModuleClient(devices)
        def set_connection_callback():
            mainenc.set_connection(devices, module_client, Message)
        module_client.schedule_method("setConnection", set_connection_callback)

async def main():
    module_client = IoTHubModuleClient.create_from_edge_environment()

    async def connect():
        await module_client.connect()

    async def wait():
        await module_client.wait_for_twin_desired_properties_patch_async()

    twin_patch_listener = module_client.on_twin_desired_properties_patch_received
    twin_patch_listener.on_twin_desired_properties_patch_received = on_twin_desired_properties_update

    await asyncio.gather(connect(), wait())

if __name__ == "__main__":
    asyncio.run(main())
